import os
import json
import csv
import shutil
from termcolor import colored
from os import scandir

# this program filters Virus Total JSON data of PE files
# checks the popular_threat_classification (family information)
# checks the how many AV Vendor tagged as malicious
# checks the first_submission_date to Virus Total. this is usel for filtering the current malware samples

input_directory = 'C:\\Users\\john\\Desktop\\json_input\\'
csv_out_path = 'C:\\Users\\john\\Desktop\\json.csv'
error_log = 'C:\\Users\\john\\Desktop\\error.log'
unwanted_log = 'C:\\Users\\john\\Desktop\\unwanted.log'

# enumerates the files in input path
dir_entry = scandir(input_directory)

count_2021 = 0
count_2022 = 0
total_count = 0
unwanted_count = 0
count_error = 0
for entry in dir_entry:
	
	try:
		file_name = entry.name
		input_path = input_directory + file_name
		
		f = open (input_path)
		data = json.loads(f.read())
		total_count+=1
		classification = data["data"]["attributes"]["popular_threat_classification"]["suggested_threat_label"]
		mal_count = data["data"]["attributes"]["last_analysis_stats"]["malicious"]
		first_seen_date = data["data"]["attributes"]["first_submission_date"]
		csv_data = [file_name , classification, first_seen_date]
		
		if mal_count>=5:
			if first_seen_date >= 1609459200 and first_seen_date<1640995200: #Year_2021
				count_2021+=1
				with open(csv_out_path,"a",newline='') as o:
					writer = csv.writer(o)
					writer.writerow(csv_data)
			if first_seen_date >= 1640995200: #Year_2022
				count_2022+=1
				with open(csv_out_path,"a",newline='') as o:
					writer = csv.writer(o)
					writer.writerow(csv_data)	
		else:
			print(colored("Unwanted file :",'gray'),colored(file_name,'white'))        
			with open (unwanted_log, "a") as u:
				u.write("unwanted file : " + file_name + '\n')
				unwanted_count+=1
			continue
	except:
		print(colored("ERROR filtering JSON :",'red'),colored(file_name,'yellow'))
		with open (error_log, "a") as e:
			e.write("json parsing error : " + file_name + '\n')
			count_error+=1
			
# check missing_count with a simple math