import os
import json
import requests
from termcolor import colored

# this script downloads the Virus Total information of malware sample in json format.

scan_output_path = '/path/to/download/json_data/'

url = 'https://www.virustotal.com/api/v3/files/'

headers = {
    'x-apikey': 'your_private_api_key' # you can get it from Virus Total        
}

if not os.path.exists(scan_output_path):
    os.makedirs(scan_output_path)

# reads the hash of the samples.
hash_file = open("download_json_files.txt","r")
hashes = hash_file.read().splitlines()

counter = 0
error_count = 0
#enumarate hashes.
for hash in hashes:
	vt_scan_url = url + hash
	response = requests.get(url=vt_scan_url, headers = headers)
	json_out = json.loads(response.text)
	
	if counter == 1000 or response.status_code == 429:
		print(colored("*****Quota is over...Exit Process*****",'green'))
		break
	
	if response.status_code == 200:
		counter += 1
			
		file_type =json_out["data"]["attributes"]["type_description"] 
        #file_family = json_out ["data"]["attributes"]["sandbox_verdicts"]["malware_names"]
		
		if file_type == "Win32 EXE":
			print(counter, hash)
			with open ("filtered.txt","a") as filtered:
				filtered.write(hash + '\n')
			with open (scan_output_path + hash, "w") as out:
				out.write(response.text)
				out.close
		else:
			print(colored("Different File Format :",'yellow'),colored(hash,'white')) 
			with open ("dif_file_format.txt","a") as d:
				d.write(hash + " : " + file_type + '\n')   	
	else:	#error message.		
		status = str(response.status_code)
		error_count += 1
		counter += 1
		print(counter, colored("ERROR scanning sample :",'red'),colored(hash,'white'), "status----> ", response.status_code)
		with open ("error.log", "a") as e:
			e.write (hash + " : " + status + "\n")

hash_file.close()
